import 'dart:io';

import 'package:drift/drift.dart';
import 'package:drift/native.dart';
import 'package:path/path.dart' as p;
import 'package:path_provider/path_provider.dart';

part 'app_database.g.dart';

// Sipari≈ü durumlarƒ± i√ßin enum
enum OrderStatus {
  pending, // Bekliyor
  partial, // Kƒ±smen G√∂nderildi
  completed // Tamamlandƒ±
}

class OrderStatusConverter extends TypeConverter<OrderStatus, String> {
  const OrderStatusConverter();

  @override
  OrderStatus fromSql(String fromDb) {
    return OrderStatus.values.firstWhere((e) => e.name == fromDb);
  }

  @override
  String toSql(OrderStatus value) {
    return value.name;
  }
}

// Sipari≈ü tablosu
class Orders extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get orderCode => text()();
  TextColumn get customerName => text()();
  TextColumn get status => text().map(const OrderStatusConverter())();
  DateTimeColumn get createdAt => dateTime().withDefault(currentDateAndTime)();
  DateTimeColumn get updatedAt => dateTime().withDefault(currentDateAndTime)();
}

// Sipari≈ü kalemleri tablosu
class OrderItems extends Table {
  IntColumn get id => integer().autoIncrement()();
  IntColumn get orderId => integer().references(Orders, #id)();
  IntColumn get productId => integer().references(Products, #id)();
  IntColumn get quantity => integer()();
  IntColumn get scannedQuantity => integer().withDefault(const Constant(0))();
}

// √úr√ºnler tablosu
class Products extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get ourProductCode => text()();
  TextColumn get name => text()();
  TextColumn get barcode => text()();
  BoolColumn get isUniqueBarcodeRequired =>
      boolean().withDefault(const Constant(false))();
}

// √úr√ºn kodu e≈üle≈ütirme tablosu
class ProductCodeMappings extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get customerProductCode => text()();
  IntColumn get productId => integer().references(Products, #id)();
  TextColumn get customerName => text()();
}

// Barkod okuma kayƒ±tlarƒ± tablosu
class BarcodeReads extends Table {
  IntColumn get id => integer().autoIncrement()();
  IntColumn get orderId => integer().references(Orders, #id)();
  IntColumn get productId => integer().nullable().references(Products, #id)();
  TextColumn get barcode => text()();
  IntColumn get boxNumber => integer().nullable()(); // Koli numarasƒ±
  DateTimeColumn get readAt => dateTime().withDefault(currentDateAndTime)();
}

// Koli y√∂netimi tablosu
class Boxes extends Table {
  IntColumn get id => integer().autoIncrement()();
  IntColumn get orderId => integer().references(Orders, #id)();
  IntColumn get boxNumber => integer()(); // Koli numarasƒ± (1, 2, 3, ...)
  DateTimeColumn get createdAt => dateTime().withDefault(currentDateAndTime)();
  DateTimeColumn get updatedAt => dateTime().withDefault(currentDateAndTime)();
}

// Teslimat tablosu
class Deliveries extends Table {
  IntColumn get id => integer().autoIncrement()();
  IntColumn get orderId => integer().references(Orders, #id)();
  DateTimeColumn get deliveryDate =>
      dateTime().withDefault(currentDateAndTime)();
}

// Teslimat kalemleri tablosu
class DeliveryItems extends Table {
  IntColumn get id => integer().autoIncrement()();
  IntColumn get deliveryId => integer().references(Deliveries, #id)();
  IntColumn get productId => integer().references(Products, #id)();
  IntColumn get quantity => integer()();
}

@DriftDatabase(
  tables: [
    Orders,
    OrderItems,
    Products,
    ProductCodeMappings,
    BarcodeReads,
    Boxes,
    Deliveries,
    DeliveryItems,
  ],
)
class AppDatabase extends _$AppDatabase {
  AppDatabase() : super(_openConnection());

  @override
  int get schemaVersion => 4;

  @override
  MigrationStrategy get migration {
    return MigrationStrategy(
      onCreate: (Migrator m) async {
        print('üèóÔ∏è Database: Creating all tables...');
        await m.createAll();
        print('‚úÖ Database: All tables created successfully');

        // √ñrnek veri olu≈ütur
        await _initializeSampleData();
      },
      onUpgrade: (Migrator m, int from, int to) async {
        if (from == 1 && to == 2) {
          // Barkod alanƒ±nƒ± Products tablosuna ekle
          await m.addColumn(products, products.barcode);
        }
        if (from == 2 && to == 3) {
          // Koli sistemi i√ßin yeni tablolar ve s√ºtunlar ekle
          await m.createTable(boxes);
          await m.addColumn(barcodeReads, barcodeReads.boxNumber);
        }
        if (from == 3 && to == 4) {
          // Schema deƒüi≈üikliƒüi yok, sadece veri g√ºncelleme
          print('üîÑ Database: Version 4 migration - updating sample data');
        }
      },
    );
  }

  /// √ñrnek veri olu≈üturma fonksiyonu
  Future<void> _initializeSampleData() async {
    print('üèóÔ∏è Database: Initializing sample data...');

    try {
      // √ñnce mevcut t√ºm verileri temizle
      await _clearAllData();

      // 10 farklƒ± √ºr√ºn olu≈ütur (detaylƒ± ve ger√ßek√ßi)
      final productCompanions = [
        ProductsCompanion.insert(
          ourProductCode: 'ABC001',
          name: 'Premium Kahve Makinesi',
          barcode: '8697123456789',
          isUniqueBarcodeRequired: const Value(true),
        ),
        ProductsCompanion.insert(
          ourProductCode: 'ABC002',
          name: 'Deluxe Blender Seti',
          barcode: '8697234567890',
          isUniqueBarcodeRequired: const Value(false),
        ),
        ProductsCompanion.insert(
          ourProductCode: 'ABC003',
          name: 'Akƒ±llƒ± Robot S√ºp√ºrge',
          barcode: '8697345678901',
          isUniqueBarcodeRequired: const Value(true),
        ),
        ProductsCompanion.insert(
          ourProductCode: 'ABC004',
          name: 'Elektrikli √áay Makinesi',
          barcode: '8697456789012',
          isUniqueBarcodeRequired: const Value(false),
        ),
        ProductsCompanion.insert(
          ourProductCode: 'ABC005',
          name: 'Mikser Set 3 Par√ßa',
          barcode: '8697567890123',
          isUniqueBarcodeRequired: const Value(false),
        ),
        ProductsCompanion.insert(
          ourProductCode: 'ABC006',
          name: 'Profesyonel Tost Makinesi',
          barcode: '8697678901234',
          isUniqueBarcodeRequired: const Value(false),
        ),
        ProductsCompanion.insert(
          ourProductCode: 'ABC007',
          name: 'Otomatik Kahve Deƒüirmeni',
          barcode: '8697789012345',
          isUniqueBarcodeRequired: const Value(true),
        ),
        ProductsCompanion.insert(
          ourProductCode: 'ABC008',
          name: 'Dijital Terazi Hassas',
          barcode: '8697890123456',
          isUniqueBarcodeRequired: const Value(false),
        ),
        ProductsCompanion.insert(
          ourProductCode: 'ABC009',
          name: 'Mutfak Robot √áok Fonksiyonlu',
          barcode: '8697901234567',
          isUniqueBarcodeRequired: const Value(true),
        ),
        ProductsCompanion.insert(
          ourProductCode: 'ABC010',
          name: 'Steam √út√º Profesyonel',
          barcode: '8698012345678',
          isUniqueBarcodeRequired: const Value(false),
        ),
      ];

      final List<int> productIds = [];
      for (final product in productCompanions) {
        final id = await into(products).insert(product);
        productIds.add(id);
        print(
            '‚úÖ Database: Created product: ${product.ourProductCode.value} - ${product.name.value} - Barkod: ${product.barcode.value}');
      }

      // 5 farklƒ± sipari≈ü olu≈ütur (detaylƒ± m√º≈üteri bilgileri ile)
      final orderCompanions = [
        OrdersCompanion.insert(
          orderCode: 'SIP2024001',
          customerName: 'MediaMarkt T√ºrkiye',
          status: OrderStatus.pending,
        ),
        OrdersCompanion.insert(
          orderCode: 'SIP2024002',
          customerName: 'Teknosa Maƒüazacƒ±lƒ±k',
          status: OrderStatus.partial,
        ),
        OrdersCompanion.insert(
          orderCode: 'SIP2024003',
          customerName: 'Vatan Bilgisayar A.≈û.',
          status: OrderStatus.completed,
        ),
        OrdersCompanion.insert(
          orderCode: 'SIP2024004',
          customerName: 'Beko Global Satƒ±≈ü',
          status: OrderStatus.pending,
        ),
        OrdersCompanion.insert(
          orderCode: 'SIP2024005',
          customerName: 'Carrefour Sabancƒ± Ticaret',
          status: OrderStatus.partial,
        ),
      ];

      final List<int> orderIds = [];
      for (final order in orderCompanions) {
        final id = await into(orders).insert(order);
        orderIds.add(id);
        print(
            '‚úÖ Database: Created order: ${order.orderCode.value} for ${order.customerName.value}');
      }

      // Detaylƒ± sipari≈ü kalemleri olu≈ütur
      final orderItemCompanions = [
        // SIP2024001 - MediaMarkt (Bekliyor durumunda, kƒ±smen okunmu≈ü)
        OrderItemsCompanion.insert(
          orderId: orderIds[0],
          productId: productIds[0], // Premium Kahve Makinesi
          quantity: 150,
          scannedQuantity: const Value(45),
        ),
        OrderItemsCompanion.insert(
          orderId: orderIds[0],
          productId: productIds[1], // Deluxe Blender Seti
          quantity: 100,
          scannedQuantity: const Value(0),
        ),
        OrderItemsCompanion.insert(
          orderId: orderIds[0],
          productId: productIds[4], // Mikser Set 3 Par√ßa
          quantity: 80,
          scannedQuantity: const Value(25),
        ),

        // SIP2024002 - Teknosa (Kƒ±smen tamamlanmƒ±≈ü)
        OrderItemsCompanion.insert(
          orderId: orderIds[1],
          productId: productIds[2], // Akƒ±llƒ± Robot S√ºp√ºrge
          quantity: 75,
          scannedQuantity: const Value(75),
        ),
        OrderItemsCompanion.insert(
          orderId: orderIds[1],
          productId: productIds[3], // Elektrikli √áay Makinesi
          quantity: 120,
          scannedQuantity: const Value(90),
        ),
        OrderItemsCompanion.insert(
          orderId: orderIds[1],
          productId: productIds[7], // Dijital Terazi Hassas
          quantity: 60,
          scannedQuantity: const Value(0),
        ),

        // SIP2024003 - Vatan (Tamamlanmƒ±≈ü)
        OrderItemsCompanion.insert(
          orderId: orderIds[2],
          productId: productIds[6], // Otomatik Kahve Deƒüirmeni
          quantity: 40,
          scannedQuantity: const Value(40),
        ),
        OrderItemsCompanion.insert(
          orderId: orderIds[2],
          productId: productIds[8], // Mutfak Robot √áok Fonksiyonlu
          quantity: 25,
          scannedQuantity: const Value(25),
        ),

        // SIP2024004 - Beko (Bekliyor, hi√ß okunmamƒ±≈ü)
        OrderItemsCompanion.insert(
          orderId: orderIds[3],
          productId: productIds[5], // Profesyonel Tost Makinesi
          quantity: 200,
          scannedQuantity: const Value(0),
        ),
        OrderItemsCompanion.insert(
          orderId: orderIds[3],
          productId: productIds[9], // Steam √út√º Profesyonel
          quantity: 180,
          scannedQuantity: const Value(0),
        ),
        OrderItemsCompanion.insert(
          orderId: orderIds[3],
          productId: productIds[1], // Deluxe Blender Seti
          quantity: 95,
          scannedQuantity: const Value(0),
        ),

        // SIP2024005 - Carrefour (Kƒ±smen okunmu≈ü)
        OrderItemsCompanion.insert(
          orderId: orderIds[4],
          productId: productIds[0], // Premium Kahve Makinesi
          quantity: 85,
          scannedQuantity: const Value(55),
        ),
        OrderItemsCompanion.insert(
          orderId: orderIds[4],
          productId: productIds[4], // Mikser Set 3 Par√ßa
          quantity: 110,
          scannedQuantity: const Value(110),
        ),
        OrderItemsCompanion.insert(
          orderId: orderIds[4],
          productId: productIds[7], // Dijital Terazi Hassas
          quantity: 70,
          scannedQuantity: const Value(35),
        ),
      ];

      for (final item in orderItemCompanions) {
        await into(orderItems).insert(item);
      }
      print('‚úÖ Database: Created ${orderItemCompanions.length} order items');

      // M√º≈üteri √ºr√ºn kodu e≈üle≈ütirmeleri olu≈ütur
      final mappingCompanions = [
        // MediaMarkt e≈üle≈ütirmeleri
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'MM-COFFEE-001',
          productId: productIds[0],
          customerName: 'MediaMarkt T√ºrkiye',
        ),
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'MM-BLEND-002',
          productId: productIds[1],
          customerName: 'MediaMarkt T√ºrkiye',
        ),
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'MM-MIX-005',
          productId: productIds[4],
          customerName: 'MediaMarkt T√ºrkiye',
        ),

        // Teknosa e≈üle≈ütirmeleri
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'TK-ROBOT-003',
          productId: productIds[2],
          customerName: 'Teknosa Maƒüazacƒ±lƒ±k',
        ),
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'TK-TEA-004',
          productId: productIds[3],
          customerName: 'Teknosa Maƒüazacƒ±lƒ±k',
        ),
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'TK-SCALE-008',
          productId: productIds[7],
          customerName: 'Teknosa Maƒüazacƒ±lƒ±k',
        ),

        // Vatan e≈üle≈ütirmeleri
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'VT-GRIND-007',
          productId: productIds[6],
          customerName: 'Vatan Bilgisayar A.≈û.',
        ),
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'VT-ROBOT-009',
          productId: productIds[8],
          customerName: 'Vatan Bilgisayar A.≈û.',
        ),

        // Beko e≈üle≈ütirmeleri
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'BK-TOAST-006',
          productId: productIds[5],
          customerName: 'Beko Global Satƒ±≈ü',
        ),
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'BK-IRON-010',
          productId: productIds[9],
          customerName: 'Beko Global Satƒ±≈ü',
        ),
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'BK-BLEND-002',
          productId: productIds[1],
          customerName: 'Beko Global Satƒ±≈ü',
        ),

        // Carrefour e≈üle≈ütirmeleri
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'CR-COFFEE-001',
          productId: productIds[0],
          customerName: 'Carrefour Sabancƒ± Ticaret',
        ),
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'CR-MIX-005',
          productId: productIds[4],
          customerName: 'Carrefour Sabancƒ± Ticaret',
        ),
        ProductCodeMappingsCompanion.insert(
          customerProductCode: 'CR-SCALE-008',
          productId: productIds[7],
          customerName: 'Carrefour Sabancƒ± Ticaret',
        ),
      ];

      for (final mapping in mappingCompanions) {
        await into(productCodeMappings).insert(mapping);
      }
      print(
          '‚úÖ Database: Created ${mappingCompanions.length} product code mappings');

      // √ñrnek barkod okuma kayƒ±tlarƒ± olu≈ütur (sadece kƒ±smen/tamamen okunanlar i√ßin)
      final barcodeReadCompanions = [
        // MediaMarkt sipari≈üi i√ßin okuma kayƒ±tlarƒ±
        ...List.generate(
            45,
            (index) => BarcodeReadsCompanion.insert(
                  orderId: orderIds[0],
                  productId: Value(productIds[0]),
                  barcode: '8697123456789',
                  boxNumber:
                      Value((index ~/ 15) + 1), // Her 15 √ºr√ºn i√ßin bir koli
                )),
        ...List.generate(
            25,
            (index) => BarcodeReadsCompanion.insert(
                  orderId: orderIds[0],
                  productId: Value(productIds[4]),
                  barcode: '8697567890123',
                  boxNumber: Value((index ~/ 15) + 1),
                )),

        // Teknosa sipari≈üi i√ßin okuma kayƒ±tlarƒ±
        ...List.generate(
            75,
            (index) => BarcodeReadsCompanion.insert(
                  orderId: orderIds[1],
                  productId: Value(productIds[2]),
                  barcode: '8697345678901',
                  boxNumber: Value((index ~/ 15) + 1),
                )),
        ...List.generate(
            90,
            (index) => BarcodeReadsCompanion.insert(
                  orderId: orderIds[1],
                  productId: Value(productIds[3]),
                  barcode: '8697456789012',
                  boxNumber: Value((index ~/ 15) + 1),
                )),

        // Vatan sipari≈üi i√ßin okuma kayƒ±tlarƒ± (tamamlanmƒ±≈ü)
        ...List.generate(
            40,
            (index) => BarcodeReadsCompanion.insert(
                  orderId: orderIds[2],
                  productId: Value(productIds[6]),
                  barcode: '8697789012345',
                  boxNumber: Value((index ~/ 15) + 1),
                )),
        ...List.generate(
            25,
            (index) => BarcodeReadsCompanion.insert(
                  orderId: orderIds[2],
                  productId: Value(productIds[8]),
                  barcode: '8697901234567',
                  boxNumber: Value((index ~/ 15) + 1),
                )),

        // Carrefour sipari≈üi i√ßin okuma kayƒ±tlarƒ±
        ...List.generate(
            55,
            (index) => BarcodeReadsCompanion.insert(
                  orderId: orderIds[4],
                  productId: Value(productIds[0]),
                  barcode: '8697123456789',
                  boxNumber: Value((index ~/ 15) + 1),
                )),
        ...List.generate(
            110,
            (index) => BarcodeReadsCompanion.insert(
                  orderId: orderIds[4],
                  productId: Value(productIds[4]),
                  barcode: '8697567890123',
                  boxNumber: Value((index ~/ 15) + 1),
                )),
        ...List.generate(
            35,
            (index) => BarcodeReadsCompanion.insert(
                  orderId: orderIds[4],
                  productId: Value(productIds[7]),
                  barcode: '8697890123456',
                  boxNumber: Value((index ~/ 15) + 1),
                )),
      ];

      for (final barcodeRead in barcodeReadCompanions) {
        await into(barcodeReads).insert(barcodeRead);
      }
      print(
          '‚úÖ Database: Created ${barcodeReadCompanions.length} barcode read records');

      print('üéâ Database: Sample data initialization completed successfully!');
      print('üìä Database: Created 5 comprehensive orders with realistic data');
    } catch (e) {
      print('üí• Database: Error initializing sample data: $e');
    }
  }

  /// T√ºm verileri temizle
  Future<void> _clearAllData() async {
    print('üßπ Database: Clearing all existing data...');

    try {
      // Tablolarƒ± baƒüƒ±mlƒ±lƒ±k sƒ±rasƒ±na g√∂re temizle (foreign key constraints)
      // Her tablo i√ßin try-catch kullan, tablo yoksa devam et

      try {
        await delete(barcodeReads).go();
        print('‚úÖ Cleared: barcodeReads');
      } catch (e) {
        print('‚ö†Ô∏è Skip: barcodeReads (table may not exist)');
      }

      try {
        await delete(deliveryItems).go();
        print('‚úÖ Cleared: deliveryItems');
      } catch (e) {
        print('‚ö†Ô∏è Skip: deliveryItems (table may not exist)');
      }

      try {
        await delete(deliveries).go();
        print('‚úÖ Cleared: deliveries');
      } catch (e) {
        print('‚ö†Ô∏è Skip: deliveries (table may not exist)');
      }

      try {
        await delete(boxes).go();
        print('‚úÖ Cleared: boxes');
      } catch (e) {
        print('‚ö†Ô∏è Skip: boxes (table may not exist)');
      }

      try {
        await delete(orderItems).go();
        print('‚úÖ Cleared: orderItems');
      } catch (e) {
        print('‚ö†Ô∏è Skip: orderItems (table may not exist)');
      }

      try {
        await delete(productCodeMappings).go();
        print('‚úÖ Cleared: productCodeMappings');
      } catch (e) {
        print('‚ö†Ô∏è Skip: productCodeMappings (table may not exist)');
      }

      try {
        await delete(orders).go();
        print('‚úÖ Cleared: orders');
      } catch (e) {
        print('‚ö†Ô∏è Skip: orders (table may not exist)');
      }

      try {
        await delete(products).go();
        print('‚úÖ Cleared: products');
      } catch (e) {
        print('‚ö†Ô∏è Skip: products (table may not exist)');
      }

      print('‚úÖ Database: All data cleared successfully');
    } catch (e) {
      print('üí• Database: Error during data clearing: $e');
      rethrow;
    }
  }

  /// Public method - Veritabanƒ±nƒ± sƒ±fƒ±rlayƒ±p yeniden olu≈ütur (debug ama√ßlƒ±)
  Future<void> resetDatabase() async {
    await _clearAllData();
  }
}

LazyDatabase _openConnection() {
  return LazyDatabase(() async {
    final dbFolder = await getApplicationDocumentsDirectory();
    final file = File(p.join(dbFolder.path, 'paketleme_takip.db'));
    return NativeDatabase(file);
  });
}
